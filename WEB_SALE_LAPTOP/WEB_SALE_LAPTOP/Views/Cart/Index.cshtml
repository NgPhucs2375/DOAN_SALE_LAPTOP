@model List<WEB_SALE_LAPTOP.Models.CartItem>

@{
    ViewBag.Title = "Giỏ hàng của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section styles {
    @Styles.Render("~/Content/css/checkout")
    <style>
        /* Custom CSS cho trang Giỏ hàng Pro */
        .cart-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 0;
        }

        /* Stepper */
        .checkout-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            width: 120px;
        }

            .progress-step .step-icon {
                width: 40px;
                height: 40px;
                background: #e2e8f0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #64748b;
                font-weight: bold;
                margin-bottom: 8px;
                transition: all 0.3s;
            }

            .progress-step.active .step-icon {
                background: var(--color-primary);
                color: white;
                box-shadow: 0 0 0 5px rgba(15, 23, 42, 0.1);
            }

            .progress-step .step-label {
                font-size: 0.85rem;
                color: #64748b;
                font-weight: 500;
            }

            .progress-step.active .step-label {
                color: var(--color-primary);
                font-weight: 700;
            }

        .progress-line {
            flex-grow: 1;
            height: 2px;
            background: #e2e8f0;
            margin-top: 20px;
            max-width: 100px;
        }

        /* Cart Item */
        .cart-item-modern {
            display: grid;
            grid-template-columns: 100px 1fr auto;
            gap: 20px;
            padding: 1.5rem 0;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
        }

            .cart-item-modern:last-child {
                border-bottom: none;
            }

        .cart-img-box {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #f1f5f9;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .cart-img-box img {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            }

        .cart-info h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .cart-info .unit-price {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .cart-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .total-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-accent);
        }

        /* Quantity Input Custom */
        .qty-control {
            display: flex;
            align-items: center;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .qty-btn {
            border: none;
            background: #fff;
            width: 32px;
            height: 32px;
            cursor: pointer;
            color: var(--text-dark);
            transition: background 0.2s;
        }

            .qty-btn:hover {
                background: #f8fafc;
                color: var(--color-primary);
            }

        .qty-input {
            width: 40px;
            border: none;
            text-align: center;
            font-weight: 600;
            outline: none;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        /* Remove Button */
        .btn-remove-item {
            color: #94a3b8;
            font-size: 0.9rem;
            text-decoration: none;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .btn-remove-item:hover {
                color: var(--color-accent);
            }

        /* Summary Box */
        .cart-summary-box {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            position: sticky;
            top: 100px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--text-dark);
        }

        .summary-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 1rem 0;
        }

        .summary-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .summary-total-label {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .summary-total-value {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        /* Voucher Field */
        .voucher-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        .voucher-input {
            flex-grow: 1;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            outline: none;
            transition: border 0.2s;
        }

            .voucher-input:focus {
                border-color: var(--color-primary);
            }

        .btn-voucher {
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

            .btn-voucher:hover {
                background: #002233;
            }

        /* Checkout Button */
        .btn-checkout-now {
            display: block;
            width: 100%;
            background: var(--color-accent);
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            text-decoration: none;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(225, 29, 72, 0.3);
        }

            .btn-checkout-now:hover {
                background: #be123c;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(225, 29, 72, 0.4);
                color: white;
            }
    </style>
}

<div class="cart-container">

    <div class="checkout-progress">
        <div class="progress-step active">
            <div class="step-icon">1</div>
            <div class="step-label">Giỏ hàng</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
            <div class="step-icon">2</div>
            <div class="step-label">Thanh toán</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
            <div class="step-icon">3</div>
            <div class="step-label">Hoàn tất</div>
        </div>
    </div>

    @if (Model == null || Model.Count == 0)
    {
        <div style="text-align: center; padding: 4rem 0;">
            <img src="https://cdn-icons-png.flaticon.com/512/11329/11329060.png" alt="Empty Cart" style="width: 200px; opacity: 0.5; margin-bottom: 2rem;">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">Giỏ hàng của bạn đang trống</h2>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Hãy chọn những sản phẩm yêu thích để lấp đầy giỏ hàng nhé!</p>
            <a href="@Url.Action("Index", "Home")" class="btn-checkout-now" style="max-width: 250px; margin: 0 auto; background: var(--color-primary); box-shadow: none;">
                <i class="fa-solid fa-arrow-left"></i> Tiếp tục mua sắm
            </a>
        </div>
    }
    else
    {
        <div style="display: grid; grid-template-columns: 1.8fr 1fr; gap: 3rem; align-items: start;">

            <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid #e2e8f0; box-shadow: 0 2px 10px rgba(0,0,0,0.01);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 1rem;">
                    <h2 style="font-size: 1.25rem; margin: 0;">Giỏ hàng (@Model.Sum(x => x.SoLuong) sản phẩm)</h2>
                </div>

                @foreach (var item in Model)
                {
                    <div class="cart-item-modern">
                        <div class="cart-img-box">
                            <a href="@Url.Action("Details", "Home", new { id = item.MaLaptop })">
                                <img src="~/Content/images/@item.HinhAnh" alt="@item.TenLaptop" />
                            </a>
                        </div>

                        <div class="cart-info">
                            <a href="@Url.Action("Details", "Home", new { id = item.MaLaptop })" style="text-decoration: none;">
                                <h3>@item.TenLaptop</h3>
                            </a>
                            <div class="unit-price">Đơn giá: @String.Format("{0:N0}", item.DonGia) ₫</div>

                            <div style="margin-top: 10px;">
                                <a href="@Url.Action("RemoveItem", "Cart", new { maLaptop = item.MaLaptop })" class="btn-remove-item">
                                    <i class="fa-regular fa-trash-can"></i> Xóa
                                </a>
                            </div>
                        </div>

                        <div class="cart-actions">
                            <div class="total-price">@String.Format("{0:N0}", item.ThanhTien) ₫</div>

                            @using (Html.BeginForm("UpdateItem", "Cart", FormMethod.Post))
                            {
                                @Html.Hidden("maLaptop", item.MaLaptop)
                                <div class="qty-control">
                                    <button type="submit" name="soLuong" value="@(item.SoLuong - 1)" class="qty-btn"><i class="fa-solid fa-minus" style="font-size: 0.7rem;"></i></button>
                                    <input type="text" value="@item.SoLuong" class="qty-input" readonly />
                                    <button type="submit" name="soLuong" value="@(item.SoLuong + 1)" class="qty-btn"><i class="fa-solid fa-plus" style="font-size: 0.7rem;"></i></button>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <div class="cart-summary-box">
                <h3 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Mã giảm giá</h3>

                @using (Html.BeginForm("ApplyVoucher", "Cart", FormMethod.Post))
                {
                    <div class="voucher-input-group">
                        <input type="text" name="maVoucher" class="voucher-input" placeholder="Nhập mã ưu đãi" value="@ViewBag.MaVoucher" />
                        <button type="submit" class="btn-voucher">Áp dụng</button>
                    </div>

                    if (TempData["VoucherError"] != null)
                    {
                        <div style="color: #dc2626; font-size: 0.9rem; margin-bottom: 1rem; background: #fef2f2; padding: 8px; border-radius: 6px;">
                            <i class="fa-solid fa-circle-exclamation"></i> @TempData["VoucherError"]
                        </div>
                    }
                    if (TempData["VoucherSuccess"] != null)
                    {
                        <div style="color: #16a34a; font-size: 0.9rem; margin-bottom: 1rem; background: #f0fdf4; padding: 8px; border-radius: 6px;">
                            <i class="fa-solid fa-check-circle"></i> @TempData["VoucherSuccess"]
                        </div>
                    }
                }

                <div class="summary-divider"></div>

                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <span>@String.Format("{0:N0}", (decimal)ViewBag.TongTien) ₫</span>
                </div>

                @if ((decimal)ViewBag.SoTienGiam > 0)
                {
                    <div class="summary-row" style="color: var(--color-accent);">
                        <span>Giảm giá:</span>
                        <span>- @String.Format("{0:N0}", (decimal)ViewBag.SoTienGiam) ₫</span>
                    </div>
                }

                <div class="summary-divider"></div>

                <div class="summary-total-row">
                    <span class="summary-total-label">Tổng tiền:</span>
                    <span class="summary-total-value">@String.Format("{0:N0}", (decimal)ViewBag.TongThanhToan) ₫</span>
                </div>
                <div style="text-align: right; font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">(Đã bao gồm VAT)</div>

                <div style="margin-top: 2rem;">
                    <a href="@Url.Action("Checkout", "Cart")" class="btn-checkout-now">
                        THANH TOÁN NGAY
                    </a>
                </div>
                <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 10px;">

                    <a href="@Url.Action("Checkout", "Cart")" class="btn-checkout-now">
                        THANH TOÁN KHI NHẬN HÀNG (COD)
                    </a>

                    <a href="@Url.Action("PaymentMomo", "Payment")" class="btn-checkout-now" style="background-color: #a50064; box-shadow: 0 4px 15px rgba(165, 0, 100, 0.3);">
                        <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" style="height: 20px; vertical-align: middle; margin-right: 10px; filter: brightness(0) invert(1);">
                        THANH TOÁN QUA MOMO
                    </a>

                </div>
            </div>
        </div>
    }
</div>