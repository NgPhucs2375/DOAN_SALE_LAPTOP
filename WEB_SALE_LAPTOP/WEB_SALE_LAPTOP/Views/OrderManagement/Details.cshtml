@model WEB_SALE_LAPTOP.Models.HOADON
@{
    ViewBag.Title = "Chi tiết Đơn hàng #" + Model.MAHD;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    // Xác định tiến độ đơn hàng (0-100%)
    int progress = 0;
    string progressClass = "bg-warning"; // Mặc định vàng
    if (Model.TRANGTHAI == "Chờ xử lý") { progress = 25; }
    else if (Model.TRANGTHAI == "Đang giao") { progress = 75; progressClass = "bg-primary"; }
    else if (Model.TRANGTHAI == "Hoàn thành") { progress = 100; progressClass = "bg-success"; }
    else if (Model.TRANGTHAI == "Đã hủy") { progress = 100; progressClass = "bg-danger"; }
}

<style>
    /* Timeline Styles */
    .order-timeline {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }

        .order-timeline::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
            z-index: 0;
        }

    .timeline-step {
        position: relative;
        z-index: 1;
        text-align: center;
        width: 33.33%;
    }

    .timeline-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #e9ecef;
        color: #adb5bd;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-weight: bold;
        border: 4px solid #fff;
        transition: all 0.3s;
    }

    .timeline-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-weight: 500;
    }

    /* Active Step */
    .timeline-step.active .timeline-icon {
        background: var(--color-primary);
        color: white;
        box-shadow: 0 0 0 4px rgba(0, 48, 73, 0.2);
    }

    .timeline-step.active .timeline-label {
        color: var(--color-primary);
        font-weight: bold;
    }

    .timeline-step.completed .timeline-icon {
        background: #28a745;
        color: white;
    }

    /* Info Cards */
    .info-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 15px rgba(0,0,0,0.03);
        border: 1px solid #f0f0f0;
        height: 100%;
        transition: transform 0.2s;
    }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

    .info-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed #eee;
    }

        .info-header i {
            width: 30px;
            height: 30px;
            background: rgba(0, 48, 73, 0.1);
            color: var(--color-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

    .info-row {
        display: flex;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
    }

    .info-label {
        width: 100px;
        color: var(--text-muted);
        flex-shrink: 0;
    }

    .info-value {
        color: var(--text-dark);
        font-weight: 500;
    }

    /* Product Table Override */
    .table-container {
        box-shadow: none;
        border: 1px solid #f0f0f0;
    }

    .data-table th {
        background: #f8f9fa;
        border-bottom: 2px solid #eee;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .data-table td {
        padding: 1.2rem 1rem;
    }

    /* Summary Box */
    .order-summary-box {
        background: #fcfcfc;
        padding: 1.5rem;
        border-radius: 0 0 12px 12px;
        border: 1px solid #f0f0f0;
        border-top: none;
    }

    .summary-row {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .summary-label {
        margin-right: 2rem;
        color: var(--text-muted);
    }

    .summary-val {
        width: 150px;
        text-align: right;
        font-weight: 600;
    }

    .summary-total {
        font-size: 1.3rem;
        color: var(--color-primary);
        border-top: 1px dashed #ddd;
        padding-top: 1rem;
        margin-top: 0.5rem;
    }
</style>

<div class="page-header" style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); margin-bottom: 2rem;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <a href="@Url.Action("Index")" style="width: 40px; height: 40px; border-radius: 50%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: var(--text-dark); transition: all 0.2s;">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div>
            <h2 class="section-title" style="margin: 0; font-size: 1.5rem; border: none;">Đơn hàng #@Model.MAHD</h2>
            <span style="font-size: 0.9rem; color: var(--text-muted);">Đặt ngày: @(Model.NGAYLAP.HasValue ? Model.NGAYLAP.Value.ToString("dd/MM/yyyy HH:mm") : "...")</span>
        </div>
        <div style="margin-left: auto;">
            @if (Model.TRANGTHAI == "Chờ xử lý")
            {<span class="status status-pending" style="font-size: 1rem; padding: 8px 20px;">@Model.TRANGTHAI</span> }
        else if (Model.TRANGTHAI == "Đang giao")
        { <span class="status status-shipping" style="font-size: 1rem; padding: 8px 20px;">@Model.TRANGTHAI</span> }
    else if (Model.TRANGTHAI == "Hoàn thành")
    { <span class="status status-completed" style="font-size: 1rem; padding: 8px 20px;">@Model.TRANGTHAI</span> }
else
{ <span class="status status-cancelled" style="font-size: 1rem; padding: 8px 20px;">@Model.TRANGTHAI</span>}
        </div>
    </div>

    <div class="header-actions" style="display: flex; gap: 10px; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee; justify-content: flex-end;">
        @if (Model.TRANGTHAI == "Chờ xử lý")
        {
            using (Html.BeginForm("UpdateStatus", "OrderManagement", FormMethod.Post))
            {
                @Html.Hidden("maHD", Model.MAHD)
                @Html.Hidden("newStatus", "Đang giao")
                <button type="submit" class="btn-primary-admin" style="background-color: #007bff; padding: 10px 25px;">
                    <i class="fa-solid fa-truck-fast"></i> DUYỆT GIAO HÀNG
                </button>
            }
            using (Html.BeginForm("UpdateStatus", "OrderManagement", FormMethod.Post))
            {
                @Html.Hidden("maHD", Model.MAHD)
                @Html.Hidden("newStatus", "Đã hủy")
                <button type="submit" class="btn-primary-admin" style="background-color: white; color: var(--color-accent); border: 1px solid var(--color-accent);">
                    <i class="fa-solid fa-times"></i> Hủy đơn
                </button>
            }
        }
        else if (Model.TRANGTHAI == "Đang giao")
        {
            using (Html.BeginForm("UpdateStatus", "OrderManagement", FormMethod.Post))
            {
                @Html.Hidden("maHD", Model.MAHD)
                @Html.Hidden("newStatus", "Hoàn thành")
                <button type="submit" class="btn-primary-admin" style="background-color: #28a745; padding: 10px 25px;">
                    <i class="fa-solid fa-check-circle"></i> XÁC NHẬN HOÀN THÀNH
                </button>
            }
        }
        <button onclick="window.print()" class="btn-primary-admin" style="background-color: #6c757d; width: 40px; padding: 0; justify-content: center;" title="In hóa đơn">
            <i class="fa-solid fa-print"></i>
        </button>
    </div>
</div>

<div class="order-timeline">
    <div class="timeline-step @(progress >= 25 ? "active" : "")">
        <div class="timeline-icon"><i class="fa-solid fa-file-invoice"></i></div>
        <div class="timeline-label">Đặt hàng thành công</div>
    </div>
    <div class="timeline-step @(progress >= 75 ? "active" : "")">
        <div class="timeline-icon"><i class="fa-solid fa-truck"></i></div>
        <div class="timeline-label">Đang vận chuyển</div>
    </div>
    <div class="timeline-step @(progress == 100 ? "active" : "")">
        <div class="timeline-icon">
            @if (Model.TRANGTHAI == "Đã hủy")
            {<i class="fa-solid fa-times"></i> }
            else
            { <i class="fa-solid fa-check"></i>}
        </div>
        <div class="timeline-label">@Model.TRANGTHAI</div>
    </div>
</div>

<div class="order-details-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">

    <div class="left-column">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Sản phẩm</th>
                        <th style="text-align: center;">Đơn giá</th>
                        <th style="text-align: center;">SL</th>
                        <th style="text-align: right;">Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.CT_HOADON)
                    {
                        <tr>
                            <td>
                                <div class="product-info-cell">
                                    <div class="table-product-img" style="width: 60px; height: 60px;">
                                        @if (item.LAPTOP != null && !string.IsNullOrEmpty(item.LAPTOP.HINHANH0))
                                        {
                                            <img src="~/Content/images/@item.LAPTOP.HINHANH0" style="width: 100%; height: 100%; object-fit: contain;">
                                        }
                                        else
                                        {
                                            <i class="fa-solid fa-laptop" style="font-size: 1.5rem; color: var(--text-muted); display: flex; justify-content: center; align-items: center; height: 100%;"></i>
                                        }
                                    </div>
                                    <div class="product-info-text">
                                        <strong style="font-size: 0.95rem;">@(item.LAPTOP != null ? item.LAPTOP.TENLAPTOP : "Sản phẩm đã xóa")</strong>
                                        <small>SKU: #@item.MALAPTOP</small>
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center;">@String.Format("{0:N0}", item.DONGIA) ₫</td>
                            <td style="text-align: center; font-weight: bold;">x@item.SOLUONG</td>
                            <td style="text-align: right; font-weight: 600;">@String.Format("{0:N0}", item.THANHTIEN) ₫</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="order-summary-box">
            <div class="summary-row">
                <span class="summary-label">Tổng tiền hàng:</span>
                <span class="summary-val">@String.Format("{0:N0}", Model.TONGTIEN_HANG) ₫</span>
            </div>
            @if (Model.SOTIEN_GIAM_VOUCHER > 0)
            {
                <div class="summary-row" style="color: var(--color-accent);">
                    <span class="summary-label">Voucher giảm giá:</span>
                    <span class="summary-val">- @String.Format("{0:N0}", Model.SOTIEN_GIAM_VOUCHER) ₫</span>
                </div>
            }
            <div class="summary-row summary-total">
                <span class="summary-label">TỔNG THANH TOÁN:</span>
                <span class="summary-val">@String.Format("{0:N0}", Model.TONG_THANHTOAN) ₫</span>
            </div>
        </div>
    </div>

    <div class="right-column" style="display: flex; flex-direction: column; gap: 1.5rem;">

        <div class="info-card">
            <div class="info-header">
                <i class="fa-regular fa-user"></i>
                <h4>Thông tin Khách hàng</h4>
            </div>
            <div class="info-row">
                <span class="info-label">Họ tên:</span>
                <span class="info-value">@(Model.KHACHHANG != null ? Model.KHACHHANG.HOTEN : "Khách vãng lai")</span>
            </div>
            <div class="info-row">
                <span class="info-label">Email:</span>
                <span class="info-value">@(Model.KHACHHANG != null ? Model.KHACHHANG.EMAIL : "---")</span>
            </div>
            <div class="info-row">
                <span class="info-label">Số ĐT:</span>
                <span class="info-value">@(Model.KHACHHANG != null ? Model.KHACHHANG.SODT : "---")</span>
            </div>
        </div>

        <div class="info-card">
            <div class="info-header">
                <i class="fa-solid fa-location-dot"></i>
                <h4>Thông tin Giao hàng</h4>
            </div>
            <div class="info-row">
                <span class="info-label">Người nhận:</span>
                <span class="info-value">@(Model.KHACHHANG != null ? Model.KHACHHANG.HOTEN : "...")</span>
            </div>
            <div class="info-row">
                <span class="info-label">SĐT Nhận:</span>
                <span class="info-value">@Model.SDT_GIAO</span>
            </div>
            <div class="info-row" style="flex-direction: column;">
                <span class="info-label" style="margin-bottom: 5px;">Địa chỉ:</span>
                <span class="info-value" style="line-height: 1.4;">@Model.DIACHI_GIAO</span>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.MAVOUCHER))
        {
            <div class="info-card" style="background: #fff3cd; border-color: #ffeeba;">
                <div class="info-header">
                    <i class="fa-solid fa-ticket" style="background: rgba(133, 100, 4, 0.1); color: #856404;"></i>
                    <h4 style="color: #856404;">Voucher sử dụng</h4>
                </div>
                <div class="info-row">
                    <span class="info-label" style="color: #856404;">Mã:</span>
                    <span class="info-value" style="font-family: monospace; font-size: 1.1rem; color: #856404;">@Model.MAVOUCHER</span>
                </div>
            </div>
        }

    </div>
</div>