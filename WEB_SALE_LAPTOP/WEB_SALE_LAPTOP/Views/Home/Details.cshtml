@model WEB_SALE_LAPTOP.Models.LAPTOP
@{
    ViewBag.Title = Model.TENLAPTOP;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var images = ViewBag.ProductImages as List<string> ?? new List<string>();
    string imagePathPrefix = "/Content/images/";
    var sameBrandProducts = ViewBag.SameBrandProducts as List<WEB_SALE_LAPTOP.Models.LAPTOP>;
    var sameTypeProducts = ViewBag.SameTypeProducts as List<WEB_SALE_LAPTOP.Models.LAPTOP>;

    // Tính toán phần trăm giảm giá
    int phanTramGiam = 0;
    if (Model.GIA_GOC > 0 && Model.GIA_GOC > Model.GIA_BAN)
    {
        phanTramGiam = (int)((1 - (Model.GIA_BAN / Model.GIA_GOC)) * 100);
    }

    // --- TẠO DỮ LIỆU GIẢ (MOCK DATA) CHO ĐÁNH GIÁ ---
    var mockReviews = new List<dynamic>();
    string[] hoTenMau = { "Nguyễn Văn A", "Trần Thị B", "Lê Văn C", "Phạm Minh D", "Hoàng Thùy L", "Ngô Kiến H", "Dang Khoa", "Minh Tuấn" };
    string[] noiDungMau = { "Sản phẩm quá tuyệt vời, đóng gói kỹ.", "Giao hàng nhanh, máy đẹp như hình.", "Cấu hình mạnh, chiến game ngon.", "Nhân viên tư vấn nhiệt tình, 5 sao!", "Hàng chính hãng, check bảo hành ok.", "Pin trâu, màn hình sắc nét." };
    Random rand = new Random();

    // Tạo 15 đánh giá giả
    for (int i = 0; i < 15; i++)
    {
        mockReviews.Add(new
        {
            Name = hoTenMau[rand.Next(hoTenMau.Length)],
            Rating = rand.Next(4, 6), // Random từ 4 đến 5 sao
            Date = DateTime.Now.AddDays(-rand.Next(1, 30)).ToString("dd/MM/yyyy"),
            Content = noiDungMau[rand.Next(noiDungMau.Length)]
        });
    }
}

<style>
    a { text-decoration: none !important; }

    /* Breadcrumb */
    .breadcrumb { margin: 1rem 0; font-size: 0.9rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
    .breadcrumb a { color: var(--text-dark); font-weight: 500; transition: color 0.2s; }
    .breadcrumb a:hover { color: var(--color-primary); }

    /* Image Zoom */
    .main-image-wrapper { cursor: zoom-in; position: relative; overflow: hidden; border: 1px solid #eee; border-radius: 8px; }
    #main-product-image { transition: transform 0.3s ease-out; transform-origin: center; width: 100%; display: block; }
    .main-image-wrapper:hover #main-product-image { transform: scale(1.5); }

    /* Quantity Input */
    .quantity-wrapper { display: flex; align-items: center; gap: 0; margin-bottom: 1.5rem; }
    .btn-qty { width: 40px; height: 40px; border: 1px solid var(--border-color); background: #fff; cursor: pointer; font-weight: bold; transition: all 0.2s; }
    .btn-qty:hover { background: var(--bg-main); color: var(--color-primary); }
    .input-qty { width: 60px; height: 40px; text-align: center; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); border-left: none; border-right: none; font-weight: bold; outline: none; }

    /* Tabs */
    .product-tabs { margin-top: 3rem; background: #fff; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
    .tab-header { display: flex; border-bottom: 1px solid var(--border-color); background: #f8f9fa; }
    .tab-btn { padding: 15px 25px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-muted); font-size: 1rem; transition: all 0.3s; border-bottom: 3px solid transparent; }
    .tab-btn:hover { color: var(--color-primary); background: #eee; }
    .tab-btn.active { color: var(--color-primary); border-bottom: 3px solid var(--color-primary); background: #fff; }
    .tab-content { display: none; padding: 2rem; animation: fadeIn 0.5s; }
    .tab-content.active { display: block; }

    /* NÚT GỌI TƯ VẤN (Đã sửa đẹp) */
    .btn-call-consult {
        flex: 1;
        height: 55px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: #fff;
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
        border-radius: 8px;
        transition: all 0.3s;
    }
    .btn-call-consult:hover {
        background: var(--color-primary);
        color: white;
    }
    .btn-call-consult .text-col {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.2;
    }
    .btn-call-consult .text-main { font-weight: bold; font-size: 1rem; }
    .btn-call-consult .text-sub { font-size: 0.75rem; font-weight: normal; }

    /* REVIEW STYLES */
    .review-item { border-bottom: 1px solid #eee; padding: 1rem 0; display: flex; gap: 15px; }
    .review-avatar { width: 50px; height: 50px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; font-size: 1.2rem; }
    .review-content { flex: 1; }
    .review-name { font-weight: bold; margin-bottom: 2px; }
    .review-stars { color: #ffc107; font-size: 0.9rem; margin-bottom: 5px; }
    .review-date { font-size: 0.8rem; color: #999; }

    /* Toast Notification */
    #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; }
    .toast-message { background: #28a745; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; margin-bottom: 10px; animation: slideIn 0.5s ease; }
    @@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div class="container-fluid">
    <div class="breadcrumb">
        <a href="@Url.Action("Index", "Home")"><i class="fa-solid fa-house"></i> Trang chủ</a>
        <i class="fa-solid fa-angle-right" style="font-size: 0.8em;"></i>
        <a href="@Url.Action("TimKiemTheoLoai", "Home", new { tenLoai = (Model.LOAI_LAPTOP != null ? Model.LOAI_LAPTOP.TENLOAI : "") })">
            @(Model.LOAI_LAPTOP != null ? Model.LOAI_LAPTOP.TENLOAI : "Laptop")
        </a>
        <i class="fa-solid fa-angle-right" style="font-size: 0.8em;"></i>
        <span style="color: var(--color-accent); font-weight: 600;">@Model.TENLAPTOP</span>
    </div>
</div>

<div class="product-section">
    <div class="contact-page-wrapper" style="grid-template-columns: 1.2fr 1.8fr; gap: 3rem;">

        <div class="product-gallery">
            <div class="main-image-wrapper">
                <img id="main-product-image"
                     src="@Url.Content(imagePathPrefix + (images.Count > 0 ? images[0] : "default.png"))"
                     alt="@Model.TENLAPTOP">
            </div>

            @if (images.Count > 1)
            {
                <div class="thumbnail-list" style="margin-top: 10px;">
                    @foreach (var img in images)
                    {
                        <img class="thumbnail @(img == images[0] ? "active" : "")"
                             src="@Url.Content(imagePathPrefix + img)"
                             alt="Thumbnail">
                    }
                </div>
            }
        </div>

        <div class="product-info">

            <h1 class="section-title" style="border: none; padding: 0; margin-bottom: 0.5rem; font-size: 1.8rem; line-height: 1.3;">
                @Model.TENLAPTOP
            </h1>
            <div class="product-brand" style="margin-bottom: 1rem; font-size: 0.95rem;">
                Thương hiệu: <a href="#" style="color: var(--color-primary); font-weight: bold;">@(Model.HANG != null ? Model.HANG.TENHANG : "...")</a>
                <span style="margin: 0 10px; color: #ddd;">|</span>
                Tình trạng:
                @if (Model.SOLUONG_TON > 0)
                {
                    <span style="color: #28a745; font-weight: bold;"><i class="fa-solid fa-check-circle"></i> Còn hàng (@Model.SOLUONG_TON)</span>
                }
                else
                {
                    <span style="color: var(--color-accent); font-weight: bold;"><i class="fa-solid fa-circle-xmark"></i> Hết hàng</span>
                }
            </div>

            <div class="card-price" style="margin-top: 1rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #eee;">
                <div style="display: flex; align-items: flex-end; gap: 10px;">
                    <span class="price-new" style="font-size: 2.2rem; color: var(--color-accent); line-height: 1;">@Model.GIA_BAN.ToString("N0") ₫</span>
                    @if (Model.GIA_GOC > Model.GIA_BAN)
                    {
                        <span class="price-old" style="font-size: 1.1rem; margin-bottom: 5px;">@Model.GIA_GOC.ToString("N0") ₫</span>
                        <span class="card-badge" style="position: static; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: var(--color-accent); color: white;">-@phanTramGiam%</span>
                    }
                </div>
            </div>

            <div class="sidebar-promo-card" style="margin-top: 1.5rem; padding: 1rem; background: #fff; border: 1px dashed var(--color-accent); color: var(--text-dark); box-shadow: none;">
                <h4 class="promo-title" style="color: var(--color-accent); font-size: 1rem; margin-bottom: 0.5rem;"><i class="fa-solid fa-gift"></i> ƯU ĐÃI TẶNG KÈM</h4>
                <ul style="list-style: none; padding-left: 0; font-size: 0.95rem; margin: 0;">
                    <li style="margin-bottom: 5px;"><i class="fa-solid fa-check-circle" style="color: #28a745; margin-right: 5px;"></i> Tặng Balo Laptop Pro cao cấp chống sốc.</li>
                    <li style="margin-bottom: 5px;"><i class="fa-solid fa-check-circle" style="color: #28a745; margin-right: 5px;"></i> Tặng Chuột không dây Silent chính hãng.</li>
                    <li style="margin-bottom: 5px;"><i class="fa-solid fa-check-circle" style="color: #28a745; margin-right: 5px;"></i> Miễn phí cài đặt phần mềm trọn đời.</li>
                </ul>
            </div>

            <div style="margin-top: 2rem;">
                <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Số lượng:</label>
                <div class="quantity-wrapper">
                    <button type="button" class="btn-qty" onclick="updateQty(-1)">-</button>
                    <input type="number" id="selectedQty" class="input-qty" value="1" min="1" max="@Model.SOLUONG_TON" readonly>
                    <button type="button" class="btn-qty" onclick="updateQty(1)">+</button>
                </div>

                @if (Model.SOLUONG_TON > 0)
                {
                    using (Html.BeginForm("AddToCart", "Cart", FormMethod.Post, new { id = "addToCartForm" }))
                    {
                        @Html.Hidden("maLaptop", Model.MALAPTOP)
                        <input type="hidden" name="soLuong" id="hiddenSoLuong" value="1" />

                        <div class="card-actions" style="gap: 15px;">
                            <button type="submit" class="btn-add-cart" style="flex: 1.5; height: 55px; font-size: 1.1rem; text-transform: uppercase; font-weight: 700; border-radius: 8px;">
                                <i class="fa-solid fa-cart-shopping"></i> Mua Ngay
                            </button>

                            <a href="@Url.Action("About", "Home")" class="btn-call-consult">
                                <i class="fa-solid fa-headset" style="font-size: 1.5rem;"></i>
                                <div class="text-col">
                                    <span class="text-main">LIÊN HỆ TƯ VẤN</span>
                                    <span class="text-sub">Hỗ trợ kỹ thuật 24/7</span>
                                </div>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <button class="btn-add-cart" disabled style="background: #ccc; cursor: not-allowed; width: 100%; height: 50px; color: #666;">TẠM HẾT HÀNG</button>
                }
            </div>
        </div>
    </div>
</div>

<div class="product-tabs">
    <div class="tab-header">
        <button class="tab-btn active" onclick="openTab(event, 'tab-desc')">Mô tả chi tiết</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-specs')">Thông số kỹ thuật</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-reviews')">Đánh giá (@mockReviews.Count)</button>
    </div>

    <div id="tab-desc" class="tab-content active">
        <div style="line-height: 1.8; color: var(--text-dark);">
            @if (!string.IsNullOrEmpty(Model.MOTA))
            {
                @Html.Raw(Model.MOTA.Replace("\n", "<br>"))
            }
            else
            {
                <p>Đang cập nhật mô tả cho sản phẩm này...</p>
            }
        </div>
    </div>

    <div id="tab-specs" class="tab-content">
        <table class="config-table-pro">
            <tbody>
                @if (!string.IsNullOrEmpty(Model.CAUHINH))
                {
                    var specs = Model.CAUHINH.Split(',');
                    int i = 0;
                    foreach (var spec in specs)
                    {
                        string bgStyle = (i % 2 == 0) ? "background-color: #f9f9f9;" : "";
                        <tr>
                            <td style="@bgStyle width: 30%; font-weight: 600; color: var(--text-muted);">
                                @if (spec.ToLower().Contains("cpu") || spec.ToLower().Contains("core"))
                                {<i class="fa-solid fa-microchip"></i> <span>Vi xử lý</span> }
                                else if (spec.ToLower().Contains("ram"))
                                { <i class="fa-solid fa-memory"></i> <span>RAM</span> }
                                else if (spec.ToLower().Contains("ssd"))
                                { <i class="fa-solid fa-hard-drive"></i> <span>Ổ cứng</span> }
                                else if (spec.ToLower().Contains("màn"))
                                { <i class="fa-solid fa-desktop"></i> <span>Màn hình</span> }
                                else
                                { <i class="fa-solid fa-circle-info"></i> <span>Thông tin khác</span>}
                            </td>
                            <td style="@bgStyle font-weight: 500;">@spec.Trim()</td>
                        </tr>
                        i++;
                    }
                }
            </tbody>
        </table>
    </div>

    <div id="tab-reviews" class="tab-content">
        <div style="display: flex; align-items: center; margin-bottom: 2rem; background: #f9f9f9; padding: 1.5rem; border-radius: 8px;">
            <div style="text-align: center; margin-right: 3rem;">
                <div style="font-size: 3rem; font-weight: bold; color: var(--color-accent);">4.8</div>
                <div style="color: #ffc107;">
                    <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star-half-stroke"></i>
                </div>
                <div style="color: #777;">(@mockReviews.Count đánh giá)</div>
            </div>
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span style="width: 30px;">5 <i class="fa-solid fa-star" style="font-size: 0.7rem;"></i></span>
                    <div style="flex: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 10px; overflow: hidden;">
                        <div style="width: 80%; height: 100%; background: #28a745;"></div>
                    </div>
                    <span style="width: 30px;">80%</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <span style="width: 30px;">4 <i class="fa-solid fa-star" style="font-size: 0.7rem;"></i></span>
                    <div style="flex: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 10px; overflow: hidden;">
                        <div style="width: 20%; height: 100%; background: #28a745;"></div>
                    </div>
                    <span style="width: 30px;">20%</span>
                </div>
            </div>
        </div>

        <div class="reviews-list">
            @foreach (var review in mockReviews)
            {
                <div class="review-item">
                    <div class="review-avatar">@review.Name.Substring(0, 1)</div>
                    <div class="review-content">
                        <div class="review-name">@review.Name</div>
                        <div class="review-stars">
                            @for (int s = 0; s < review.Rating; s++)
                            {<i class="fa-solid fa-star"></i>}
                        </div>
                        <div style="color: #333; margin-bottom: 5px;">@review.Content</div>
                        <div class="review-date">@review.Date | Phân loại hàng: Mới 100%</div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="related-products-section" style="margin-top: 3rem;">

    @if (sameBrandProducts != null && sameBrandProducts.Count > 0)
    {
        <h2 class="section-title" style="font-size: 1.5rem;">Sản phẩm cùng hãng @(Model.HANG != null ? Model.HANG.TENHANG : "")</h2>
        <div class="card-container">
            @foreach (var item in sameBrandProducts)
            {
                <a href="@Url.Action("Details", "Home", new { id = item.MALAPTOP })" class="card" style="text-decoration: none;">
                    @if (item.GIA_BAN < item.GIA_GOC)
                    {<div class="card-badge">Giảm giá</div>}
                    <div class="card-img-container"><img src="@Url.Content(imagePathPrefix + (item.HINHANH0 ?? "default.png"))" class="card-img"></div>
                    <div class="card-content">
                        <h3 class="card-title" style="color: var(--text-dark);">@item.TENLAPTOP</h3>
                        <div class="card-price"><span class="price-new">@item.GIA_BAN.ToString("N0") ₫</span></div>
                    </div>
                </a>
            }
        </div>
    }

    @if (sameTypeProducts != null && sameTypeProducts.Count > 0)
    {
        <h2 class="section-title" style="font-size: 1.5rem; margin-top: 3rem;">Sản phẩm tương tự (@(Model.LOAI_LAPTOP != null ? Model.LOAI_LAPTOP.TENLOAI : ""))</h2>
        <div class="card-container">
            @foreach (var item in sameTypeProducts)
            {
                <a href="@Url.Action("Details", "Home", new { id = item.MALAPTOP })" class="card" style="text-decoration: none;">
                    @if (item.GIA_BAN < item.GIA_GOC)
                    {<div class="card-badge">Giảm giá</div>}
                    <div class="card-img-container"><img src="@Url.Content(imagePathPrefix + (item.HINHANH0 ?? "default.png"))" class="card-img"></div>
                    <div class="card-content">
                        <h3 class="card-title" style="color: var(--text-dark);">@item.TENLAPTOP</h3>
                        <div class="card-price"><span class="price-new">@item.GIA_BAN.ToString("N0") ₫</span></div>
                    </div>
                </a>
            }
        </div>
    }
</div>

<div id="toast-container"></div>

@section scripts {
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-btn");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function updateQty(change) {
            var input = document.getElementById('selectedQty');
            var hiddenInput = document.getElementById('hiddenSoLuong');
            var currentVal = parseInt(input.value);
            var maxVal = parseInt(input.getAttribute('max'));
            var newVal = currentVal + change;
            if (newVal >= 1 && newVal <= maxVal) {
                input.value = newVal;
                hiddenInput.value = newVal;
            }
        }

        $(document).ready(function () {
            const $thumbnails = $('.thumbnail');
            const $mainImage = $('#main-product-image');
            const $wrapper = $('.main-image-wrapper');

            $wrapper.on('mousemove', function (e) {
                const { left, top, width, height } = this.getBoundingClientRect();
                const x = (e.clientX - left) / width * 100;
                const y = (e.clientY - top) / height * 100;
                $mainImage.css('transform-origin', `${x}% ${y}%`);
            });

            $thumbnails.on('click', function () {
                const newImageSrc = $(this).attr('src');
                $mainImage.attr('src', newImageSrc);
                $thumbnails.removeClass('active');
                $(this).addClass('active');
            });

            $('#addToCartForm').on('submit', function (e) {
                e.preventDefault();
                var $btn = $(this).find('button[type="submit"]');
                var originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...');

                $.ajax({
                    url: this.action,
                    type: this.method,
                    data: $(this).serialize(),
                    success: function (response) {
                        showToast('Đã thêm vào giỏ hàng thành công!');
                    },
                    error: function () {
                        this.submit();
                    },
                    complete: function () {
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });

        function showToast(message) {
            var toast = $('<div class="toast-message"><i class="fa-solid fa-check-circle"></i> ' + message + '</div>');
            $('#toast-container').append(toast);
            setTimeout(function () {
                toast.fadeOut(500, function () { $(this).remove(); });
            }, 3000);
        }
    </script>
}